{"name":"PigeonMessenger","tagline":"A Wi-Fi Direct Chat for a huge amount of users","body":"# Pigeon Messenger\r\n\r\n![alt tag](http://www.stefanocappa.it/publicfiles/Github_repositories_images/Pigeon_Messenger/pigeon_messenger_header_github.png)\r\n\r\n<br>\r\nThis is a mirror of the official page https://github.com/deib-polimi/PigeonMessanger\r\n\r\n## Informations\r\nWi-Fi Direct MultiChat (aka Pigeon Messenger)  is a demo Android's application that try to overcome some Wi-Fi Direct's limitations.\r\nAt the moment, the wifi diver of commercial devices doesn't allow a device to partecipate concurrently in two Wi-Fi Direct's groups.\r\nThis app tries to overcome this limitation, indeed, a user can communicate with a large number of nearby people without an internet connection, using point-to-point communications.\r\nThe main goal is the simultaneous management of multiple chats, queuing messages sent when the connection is not available and send them at the same time as soon as possible.\r\n\r\nPigeon Messenger requires Android 4.4 KitKat (API 19) or higher. This choice is related to to the fact that in previous versions, this protocol was unstable and unreliable.\r\n\r\nIt's important to remember that this is a demo application, so features like the management of screen's rotation, standby device, wifi not available and so on, are not managed as a commercial product.\r\n\r\n## Results\r\n\r\nPigeon Messenger works with good performances.<br/>\r\nThe main problems are the \"Discovery Phase\" of this protocol and the Wi-Fi Direct's implementation in Android, in fact:<br/>\r\n1. The discovery time is too high when the number of devices increases <br/>\r\n2. After a certain time, a device is no longer discoverable from others, so you need to restart the Discovery Phase on all devices <br/>\r\n3. Sometimes, especially in KitKat, the WiFi part of Android crashes and the only way to solve this annoying problem is a complete reboot of the device (this situation is recognizable when Android can't find other network in Wi-Fi Setting's app).\r\n\r\nThis shows that it's possible to extend the Wi-Fi Direct protocol in Android in some particular and limited scenarios, for example a chat.\r\n\r\n## News\r\n- *03/13/2015* - **Pigeon Messenger** Alpha 2 (updated to Android 5.1 with the new support libraries)\r\n- *03/02/2015* - **Pigeon Messenger** Alpha 1 public release\r\n\r\n\r\n## Features\r\nYou can:<br/>\r\n1. **change the device name** with Java Reflection<br/>\r\n2. show a list of nearby devices<br/>\r\n3. manage connection and disconnection between devices<br/>\r\n4. show the ip address of a device, also if it's a client (not available in Android's official API)<br/>\r\n5. block incoming messages with blacklisted words (not enabled by default)<br/>\r\n6. block incoming messages if too short or empty (enabled by default)<br/>\r\n7. create a chat between a GO and a client<br/>\r\n8. manage an infinite number of chats<br/>\r\n9. sending messages in a chat, previously stopped, if the associated device is discoverable<br/>\r\n10. enqueue messages if the device is not discoverable, and send all of them at the next attempt to reconnect<br/>\r\n11. use *\"Eternal Discovery\"*, a way to restart the discovery phase every time that there are errors or disconnections<br/>\r\n\r\n## Future extensions\r\n- [ ] Connect more clients at the same GO without limitations\r\n- [ ] Group chats where the GO receives messages from a client and it sends these messages to all other clients in broadcast\r\n- [ ] Private chats between clients, i.e. a client uses his GO like a server to send private messages to another client, because in Wi-Fi Direct the communication between clients in a group is impossible. In this case is necessary to provide security mechanisms, like encryption, because a GO should never read private messages between its clients.\r\n- [ ] and so on... ;)\r\n\r\n\r\n## Images\r\n<br/>\r\n![alt tag](http://www.stefanocappa.it/publicfiles/Github_repositories_images/Pigeon_Messenger/tre_immagini.png)\r\n<br/>\r\n\r\n\r\n## Usage\r\n### General usage\r\n1. Activate Wi-Fi on all devices\r\n2. Open this app on all devices\r\n3. Touch the \"cardview\" under the words \"This Device\" to choose the device name\r\n2. Wait until devices are discovered\r\n3. Connect your device to another one touching an element in the list under the words \"Other Devices\"\r\n4. Chat with this device\r\n\r\n### Reconnection usage\r\n1. Activate Wi-Fi on all devices\r\n2. Open this app on all devices\r\n3. Touch the \"cardview\" under the words \"This Device\" to choose the device name\r\n2. Wait until devices are discovered\r\n3. Connect your device to another one touching an element in the list under the words \"Other Devices\"\r\n4. Chat with this device\r\n5. Disconnect one device clicking on the second icon in the toolbar\r\n6. Wait some seconds, because the \"Eternal Discovery\" requires some seconds to re-discover this device\r\n7. Write a message in the chat and wait the automatic reconnection. Alternatively connect manually to the device to continue the chat.\r\n\r\n### Queuing messages usage\r\n1. Activate Wi-Fi on all devices\r\n2. Open this app on all devices\r\n3. Touch the \"cardview\" under the words \"This Device\" to choose the device name\r\n2. Wait until devices are discovered\r\n3. Connect your device to another one touching an element in the list under the words \"Other Devices\"\r\n4. Chat with this device\r\n5. Disconnect one device clicking on the second icon in the toolbar\r\n6. Disable the Discovery Phase that was automatically restarted by \"Eternal Discovery\", so  the list under \"Other Devices\" will be empty\r\n7. Write some messages in the chat. As you can see the connection is not possible, but don't despair, because this app is able to enqueue your messages\r\n8. Restart the Discovery Phase e reconnect to the device in one of the methods described above (\"Reconnection usage\", step 7) \r\n9. All messages in the queue will be automatically sent to destination in only one message \r\n\r\n\r\n## Important things\r\n\r\n### Configuration\r\nIf you want to configure this app as you prefer, pay attention to: `Configuration.java`.\r\n\r\nIf you want to release this application without debug messages inside chats, change this constant to \"false\" :\r\n```java\r\n    public static final boolean DEBUG_VERSION = true;\r\n```\r\n\r\nIf you want to change client's and GO's ports, change this:\r\n```java\r\n    public static final int GROUPOWNER_PORT = 4545;\r\n    public static final int CLIENT_PORT = 5000;\r\n```\r\n\r\nIf you want to change the maximum number of devices that a GO can manage for the chat, change this:\r\n```java\r\n    public static final int THREAD_COUNT = 20;\r\n```\r\n\r\nThis attributes are used inside this app to exchange information between devices, like a protocol, to initialize the associated chat:\r\n```java\r\n    public static final String MAGICADDRESSKEYWORD = \"4<D<D<R<3<5<5\";\r\n    public static final String PLUSSYMBOLS = \"++++++++++++++++++++++++++\";\r\n```\r\n\r\nIf yuo want to change the termination String of all device's names change this attribute :\r\n```java\r\n    public static final String SERVICE_INSTANCE = \"polimip2p\";\r\n```\r\n\r\nThe following attributes are used inside this app:\r\n```java\r\n    public static final int THREAD_POOL_EXECUTOR_KEEP_ALIVE_TIME = 10; //don't touch this!\r\n    public static final String TXTRECORD_PROP_AVAILABLE = \"available\";\r\n    public static final String SERVICE_REG_TYPE = \"_presence._tcp\";\r\n    public static final int MESSAGE_READ = 0x400 + 1;\r\n    public static final int FIRSTMESSAGEXCHANGE = 0x400 + 2;\r\n    public static final String MESSAGE_READ_MSG = \"MESSAGE_READ\";\r\n    public static final String FIRSTMESSAGEXCHANGE_MSG = \"FIRSTMESSAGEXCHANGE\";\r\n```\r\n### Message Filter\r\nTo change/add blacklisted words pay attention to `MessageFilter.java`.\r\nEvery message that contains one or more of this words will be filtered on reception.\r\n\r\nExample: i want remove every message that contains at least one of this words: \"illegal\", \"piracy\", \"crack\", \"Piracy\".\r\nAdd to the lowerCaseBlackList this words in this way:\r\n\r\n```java\r\n    /**\r\n     * Private constructor, because is a singleton class.\r\n     */\r\n    private MessageFilter() {\r\n        lowerCaseBlackList = new ArrayList<>();\r\n        //add here all the words that you want to blacklist\r\n        lowerCaseBlackList.add(\"illegal\"); // OK\r\n        lowerCaseBlackList.add(\"piracy\"); // OK\r\n        lowerCaseBlackList.add(\"crack\"); // OK\r\n        \r\n        //useless because ev ery words in this list are elaborated as \"lower case\".\r\n        //lowerCaseBlackList.add(\"Piracy\"); // USELESS\r\n    }\r\n```\r\n### The \"@UseOnlyPrivateHere\" annotation\r\nI created this annotation as a custom java annotation to advise developers that some attributes must be private.\r\nObviously, if you want you can make every public attribute, also with this annotation, but can be very dangerous.\r\nAs you can see in `DestinationDeviceTabList` (attribute deviceList) and `ServiceList` (attribute serviceList) there is this annotation, because if you access or change this attributes without the custom logic that i implemented in these classes, to do secure operations, you can obtain Exceptions or other problems.\r\nThese classes remap list's indexes, add/set object without duplicates and in a particular way, that is very necessary to this software. Every time that you want to change something here, you should create a secure method to manage these attributes.\r\n\r\n### P2pDestinationDevice, a WifiP2pDevice abstraction\r\nIn Android you can't retrieve the current IP Address in a quick and easy way, because this method is not available in Google APIs.\r\nIts possible to do this in two ways: the first one requires to execute a shell's command, the second one requires only java.\r\nI chose the second solution, because it's quicker to implement. In particular, i get the GO's IP Address inside onConnectionInfoAvailable, but to retrieve the client's IP Address i need to ask this information to the socket on GO's side when the connection has been established.\r\nOnly GOs can retrieve Client's IP addresses, because clients can obtain only the GO's IP address.\r\nTherefore, it's necessary to send the client's IP address to the client itself from its GO, to be able to store them in a variable and use this information for something else, for example to show the ip in the UI or to open other sockets.\r\n\r\n#### GO IP Address\r\nIn `MainActivity.java`\r\n```java\r\n    @Override\r\n    public void onConnectionInfoAvailable(WifiP2pInfo p2pInfo) {\r\n    (...)\r\n    //set Group Owner ip address\r\n    TabFragment.getWiFiP2pServicesFragment().setLocalDeviceIpAddress(p2pInfo.groupOwnerAddress.getHostAddress());\r\n    (..)\r\n    }\r\n```\r\n\r\n#### Client IP Address\r\nIn `GroupOwnerSocketHandler.java`  (GO)\r\n```java\r\n    Socket clientSocket = socket.accept(); //because now i'm connected with the client/peer device\r\n    pool.execute(new ChatManager(clientSocket, handler));\r\n    ipAddress = clientSocket.getInetAddress(); //local variable with a get method\r\n```\r\n\r\nIn `MainActivity.java` (GO)\r\n```java\r\nprivate void sendAddress(String deviceMacAddress, String name, ChatManager chatManager) {\r\n    if (chatManager != null) {\r\n        InetAddress ipAddress;\r\n        if (socketHandler instanceof GroupOwnerSocketHandler) {\r\n            ipAddress = ((GroupOwnerSocketHandler) socketHandler).getIpAddress();\r\n\r\n            Log.d(TAG, \"sending message with MAGICADDRESSKEYWORD, with ipaddress= \" + ipAddress.getHostAddress());\r\n\r\n            chatManager.write((Configuration.PLUSSYMBOLS + Configuration.MAGICADDRESSKEYWORD +\r\n                        \"___\" + deviceMacAddress + \"___\" + name + \"___\" + ipAddress.getHostAddress()).getBytes());\r\n        } else {\r\n            Log.d(TAG, \"sending message with MAGICADDRESSKEYWORD, without ipaddress\");\r\n            //i use \"+\" symbols as initial spacing to be sure that also if some initial character will be lost i'll have always\r\n            //the Configuration.MAGICADDRESSKEYWORD and i can set the associated device to the correct WifiChatFragment.\r\n            chatManager.write((Configuration.PLUSSYMBOLS + Configuration.MAGICADDRESSKEYWORD +\r\n                        \"___\" + deviceMacAddress + \"___\" + name).getBytes());\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nIn `MainActivity.java` (CLIENT)\r\n```java\r\nif (readMessage.contains(Configuration.MAGICADDRESSKEYWORD)) {\r\n    WifiP2pDevice p2pDevice = new WifiP2pDevice();\r\n    p2pDevice.deviceAddress = readMessage.split(\"___\")[1];\r\n    p2pDevice.deviceName = readMessage.split(\"___\")[2];\r\n    P2pDestinationDevice device = new P2pDestinationDevice(p2pDevice);\r\n\r\n    if (readMessage.split(\"___\").length == 3) {\r\n    Log.d(TAG, \"handleMessage, p2pDevice created with: \" + p2pDevice.deviceName + \", \" + p2pDevice.deviceAddress);\r\n                        manageAddressMessageReception(device);\r\n    } else if (readMessage.split(\"___\").length == 4) {\r\n            device.setDestinationIpAddress(readMessage.split(\"___\")[3]);\r\n\r\n            //set client ip address\r\n            TabFragment.getWiFiP2pServicesFragment().setLocalDeviceIpAddress(device.getDestinationIpAddress());\r\n\r\n            Log.d(TAG, \"handleMessage, p2pDevice created with: \" + p2pDevice.deviceName + \", \"\r\n                                + p2pDevice.deviceAddress + \", \" + device.getDestinationIpAddress());\r\n            manageAddressMessageReception(device);\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n## License\r\n\r\nCopyright 2015 Stefano Cappa, Politecnico di Milano\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n\r\n<br/>\r\n**Created by Stefano Cappa**\r\n","google":"UA-61405607-3","note":"Don't delete this file! It's used internally to help with page regeneration."}